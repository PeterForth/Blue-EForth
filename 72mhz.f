

\ : DELAY
\    10000 FOR NEXT ;

\: BLINK  \ FOR Gotek STM32F105 needs mods for f103
\   \ GPIOA OUTPUT A0
\   6 40010800 !
\   20 FOR
\      1 40010814 !
\      DELAY
\      1 40010810 !
\      DELAY
\    NEXT ;

\ My f103 EForth boots to 8MHz HSI
\ Stepping the clock up to 72Mhz and dealing with
\ the change of the USART1 frequency to keep at 56K
\ Refer to RM0008

\ RCC_CR  OFFSET 0
\ 22 22 22-1 1 11-00
\ 98 76 54 9 8 76 10
\ PP PP PP C W HH HH
\ LL LL LL S S SS SS
\ LL LL LL S E EE II
\ 33 22 RO O B RO RO
\ RO RO DN N Y DN DN
\ DN DN Y    P Y  Y
\ Y  Y

\ RCC_CFGR OFFSET 4
\ 2 2211 11 11 111 100 0000 0000
\ 2 1098 76 54 321 098 7654 3210
\ O PPPP PP AA PPP PPP HHHH SSSS
\ T LLLL LL DD PPP PPP PPPP WWWW
\ G LLLL LL CC RRR RRR RRRR SS10
\ F MMMM XS PP EEE EEE EEEE 10
\ P UUUU TR RR 222 111 3210
\ R LLLL PC EE 210 210
\ E 3210 R  10
\      E

\ RCCCFGR2 OFFSET 2C
\ 1 1111 1100 0000 0000
\ 6 5432 1098 7654 3211
\ P PPPP PPPP PPPP PPPP
\ R LLLL LLLL RRRR RRRR
\ E LLLL LLLL EEEE EEEE
\ D 3333 2222 DDDD DDDD
\ I MMMM MMMM IIII IIII
\ V UUUU UUUU VVVV VVVV
\ 1 LLLL LLLL 2222 1111
\ S 3210 3210 3210 3210
\ R
\ C

: 8MHZ ( - )
 0 40021004 ! \ reset state 8MHz
 81 40021004 ! \
 10 40022000 ! \ reset condition
 8F 0FFFF 40013808 msk! ; \ 56K baud


: 72MHZ ( - ) \ Assumes reset at 8MHz HSI
\ Also check that any interrupt driven output is stable while changing clocks
BEGIN
  40013800 @ 80 AND
UNTIL  \ WAIT FOR USART TXE
  0506 0FFFF 40013808 MSK! \ KEEP 56k
  45670123 40022004 !
  CDEF89AB 40022004 ! \ UNLOCK FLASH
  45670123 40022008 !
  CDEF89AB 40022008 ! \ UNLOCK OPTIONS
  32 40022000 !   \ SET 2 WAIT STATES FOR FLASH ACCESS
\  DELAY  NOT SURE WHY IT IS NEEDED MAYBE A ISB, DSB OR DMB INSTR IS NEEDED DSB?
  [ 8F5FF3BF , ] \ DMB INSTRUCTION
\ ADDRESS 40021004
\ VALUE   MASK
\ 01C0000 3C0000  72 PLL @ 9x
\   10000  10000  PLL SOURCE PRDIV1
\    8000  0C000  ADC PRE AT 12MHZ
\     100    700  APB1DIV 2/
01D8100 03DC700 40021004 MSK! \ ABOVE COMMENT

01010000 DUP 40021000 MSK! \ START HSE AND PLL
BEGIN
  40021000 @ 2020000 AND 2020000 =
UNTIL \ WAIT FOR HSE AND PLL RDY'S
 0A 0F 40021004 MSK! \ SWITCH TO PLL
  ; \ SHOULD BE 72MHZ NOW



